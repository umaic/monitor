var map;var pL;var fromProjection;var toProjection;var features_ec;var features_dn;var markerRadius=5;var Style;var mtipo;var clear=true;var request=false;var filtro=id_filtro="";var nump_list=15;var id_depto="00";var rm_id_depto=false;var id_tema=id_org=0;var maximo=0;var jenks=[];var jenks_cl=5;var zoom=6;var layer_dn_exists=false;var layer_ec_exists=false;var layer_ft_exists=false;var layer_variacion_exists=false;var l_dn;var l_ec;var l_ft;var l_variacion;var centroColombia=ol.proj.transform([-70.963384,3.370786],"EPSG:4326","EPSG:3857");if(window.location.hostname=="monitor.local"){var subdomain_dn="desastres";var subdomain_ec="violenciaarmada";var domain=".salahumanitaria.co"}else{var subdomain_dn="desastres";var subdomain_ec="violenciaarmada";var domain=".salahumanitaria.co"}var url_ec="&server="+subdomain_ec+domain;var url_dn="&server="+subdomain_dn+domain;var _u="/json/index/?m=0";var url_ft_ec=_u+url_ec;var url_ft_dn=_u+url_dn;var url_xd="/json/cluster/?m=0&v=0";url_ec=url_xd+url_ec;url_dn=url_xd+url_dn;var markerOpacity=0.8;var selectCtrl;var l_ec,l_dn;var mapLoad=0;var _zoomOffset=6;var lym;var lytmp;var resolutions=[4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033];var show=[];show.desc=false;show.fuente=true;function getLayerByName(b){var a=[];map.getLayers().forEach(function(f,e){if(f.get("title")==b){a=[f]}});return a}function addWMSLayer(k,a,e){var f="http://geonode.salahumanitaria.co/geoserver/wms";var b=getLayerByName(k);if(b.length>0){var h=b[0];h.setVisible(e)}else{var i=new ol.source.TileWMS({url:f,params:{LAYERS:a,TILED:true,TRANSPARENT:true},serverType:"geoserver"});h=new ol.layer.Tile({title:k,source:i});var g=$("#layers_loading");i.on("tileloadstart",function(l){g.show()});i.on("tileloadend",function(l){g.hide()});map.addLayer(h)}}function selDepto(e){var b=e.split(",");var a=map.getView();a.setCenter([b[0]*1,b[1]*1]);a.setZoom(3)}function resetMap(){var a=map.getView();a.setCenter(centroColombia);a.setZoom(0)}function mapRender(){var b=new ol.View({center:centroColombia,zoom:1,resolutions:resolutions});map=new ol.Map({layers:[new ol.layer.Tile({title:"OSM",source:new ol.source.XYZ({url:"https://api.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicmF0YmlrZXIiLCJhIjoiY2loejFyM3B4MDQwcHRnbTF5MWlmOHJuNCJ9.H5A3WGVx60EdqY0hMzIMKg"})})],target:document.getElementById("map"),controls:ol.control.defaults({attributionOptions:({collapsible:false})}),view:b});var f=[new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.6)"}),stroke:new ol.style.Stroke({color:"#319FD3",width:1})})];var e=document.getElementById("popup");var a=new ol.Overlay({element:e,positioning:"bottom-center",stopEvent:false});map.addOverlay(a);map.getView().on("change:resolution",mapMove);map.on("click",function(g){var h=map.forEachFeatureAtPixel(g.pixel,function(n,l){return n});$(e).popover("destroy");if(h!==undefined&&h.get("variacion")!==undefined){var i=h.getGeometry();var k=i.getFirstCoordinate();a.setPosition(k);$(e).popover({placement:"top",html:true,title:h.get("MUNNAME"),content:"<div><b>Variación:</b> "+h.get("variacion")+"% <br /><b>Periodo 1:</b> "+h.get("p1")+"<br /><b>Periodo 2:</b> "+h.get("p2")+"</div>"});$(e).popover("show")}else{onFeatureSelect(h.getProperties())}});$(map.getViewport()).on("mousemove",function(i){var g=map.getEventPixel(i.originalEvent);var h=map.forEachFeatureAtPixel(g,function(l,k){return true});if(h){map.getTarget().style.cursor="pointer"}else{map.getTarget().style.cursor=""}});addFeaturesFirstTime()}function addFeaturesFirstTime(){addFeatures();mapLoad=1}function addFeatures(o){if(o==undefined){o="ecdn"}if(!_cluster){url_ec=url_ec.replace("cluster","index");url_dn=url_dn.replace("cluster","index")}else{url_ec=url_ec.replace("index","cluster");url_dn=url_dn.replace("index","cluster")}var b=$("#ini_date").val();var h=$("#fin_date").val();var u=map.getView().getZoom()+_zoomOffset;var t=$("#group_level").val();var q=[["s",b],["e",h],["z",u],["gl",t]];if(o=="ecdn"||o=="ft"){var n=q.concat([["v",1]]);var s=new ol.source.Vector();if(!layer_ft_exists){l_ft=new ol.layer.Vector({title:"Destacados",source:s,style:styleFtFunction});map.addLayer(l_ft);layer_ft_exists=true}else{l_ft.getSource().clear();showHideLayers("ft")}var g=addURLParameter(url_ft_dn,n);g=addURLParameter(g,[["states",getStatesChecked()]]);ajaxFeatures(g,l_ft,false);var l=addURLParameter(url_ft_ec,n);l=addURLParameter(l,[["states",getStatesChecked()]]);ajaxFeatures(l,l_ft,false)}if(o=="acceso"){var f=q.concat([["acceso",1]]);f=f.concat([["acceso_cats",getAccesoCats()]]);if(map.getLayersByName("Emergencia Compleja").length>0){l_ec=map.getLayersByName("Emergencia Compleja")[0];l_ec.removeFeatures(l_ec.features)}else{l_ec=new OpenLayers.Layer.Vector("Emergencia Compleja",{styleMap:Styles});map.addLayer(l_ec)}if(map.getLayersByName("Desastres Naturales").length>0){l_dn=map.getLayersByName("Desastres Naturales")[0];l_dn.setVisibility(false)}if(map.getLayersByName("Destacados").length>0){l_ft=map.getLayersByName("Destacados")[0];l_ft.setVisibility(false)}l=addURLParameter(url_ft_ec,f);ajaxFeatures(l,l_ec,false)}if(o=="ecdn"||o=="dn"){var k=q.concat([["c",$("#currentCatD").val()]]);var r=new ol.source.Vector({});if(!layer_dn_exists){l_dn=new ol.layer.Vector({title:"Desastres Naturales",style:styleFunction,source:r});map.addLayer(l_dn);layer_dn_exists=true}else{l_dn.getSource().clear();showHideLayers("dn")}if(l_dn.getVisible()){var a=addURLParameter(url_dn,k);a=addURLParameter(a,[["states",getStatesChecked()]]);a=addURLParameter(a,[["afectacion",getMapaAfectacion()]]);ajaxFeatures(a,l_dn,true)}}if(o=="ecdn"||o=="ec"){var p=q.concat([["c",$("#currentCatE").val()]]);var i=new ol.source.Vector();if(!layer_ec_exists){l_ec=new ol.layer.Vector({title:"Violencia",source:i,style:styleFunction});map.addLayer(l_ec);layer_ec_exists=true}else{l_ec.getSource().clear();showHideLayers("ec")}if(l_ec.getVisible()){var e=addURLParameter(url_ec,p);e=addURLParameter(e,[["states",getStatesChecked()]]);e=addURLParameter(e,[["afectacion",getMapaAfectacion()]]);ajaxFeatures(e,l_ec,true)}}}function ajaxFeatures(b,a,e){$.ajax({url:b,dataType:"jsonp",success:function(h){if(h.features.length>0){var k=(new ol.format.GeoJSON()).readFeatures(h,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});if(e){var i=h.features;var g=[];for(j in i){c=i[j].properties.count;if(c>maximo){maximo=c}g[j]=c}var f=g.length;if(f>1){if(f<=jenks_cl){jenks_cl=f+1}serie=new geostats(g);cl=(f<jenks_cl)?f-1:jenks_cl;jenks=serie.getClassJenks(cl)}}a.getSource().addFeatures(k);$("#loading").hide();showHideFeaturedIcon()}},beforeSend:function(){$("#loading").show()}})}function onFeatureSelect(e){var b="";var g=20;if(e.link.indexOf("index")>0){var f=e.link.replace("reports","monitor").replace("index","reports_list_map");var a;if(f.indexOf(subdomain_ec)>0){a=$("#currentCatE").val()}else{a=$("#currentCatD").val()}f+="&c="+a}else{var f=e.link.replace("reports","monitor").replace("view","single_report_map")}$.ajax({url:f,dataType:"jsonp",beforeSend:function(){$("#loading").show()},success:function(r){$("#loading").hide();for(var q=0,o=r.length;q<o;q+=1){_js=r[q];b+='<div class="report_list_map from_map"> <div class="t"><a href="#" onclick="return false;" title="'+_js.id+'">'+_js.t+'</a></div> <div><div class="date detail">'+_js.d+'</div> <div class="loc detail">'+_js.ln+' <span class="pdf opt"> <a href="http://sidih.colombiassh.org/sissh/download_pdf.php?c=2&id_depto='+_js.ld+'&id_mun=" target="_blank">Consulte el perfil de '+_js.ldn+"</a></span></div> </div>";b+='<div class="clear"></div><div class="left"><b>Categorias</b></div> <div class="opt right linko"><a href="http://www.colombiassh.org/gtmi/wiki/index.php/Sistema_de_categor%C3%ADas_del_m%C3%B3dulo_de_eventos_de_conflicto" target="_blank">Definici&oacute;n de categorias</a></div>';for(c in _js.c){b+='<div class="clear detail"> &raquo;'+c;if(_js.c[c].length>0){b+=": "}for(d in _js.c[c]){if(d>0){b+=", "}b+=_js.c[c][d]}b+="</div>"}b+='<div class="clear"></div> ';if(_js.q=="violencia"){if(_js.v.length>0){b+="<div><b>Víctimas</b></div> ";for(v in _js.v){_v=_js.v[v];b+='<div class="victim"><div class="right">'+_v.category+"</div><table><tr>";b+='<td valign="top">';b+="<div><b>Cantidad</b>: "+_v.cant+"</div> ";if(_v.gender!=""){b+="<div> <b>Género:</b> "+_v.gender+"</div> "}if(_v.status!=""){b+="<div> <b>Estado:</b> "+_v.status+"</div> "}b+="</td>";b+='<td valign="top">';if(_v.age!=""){b+="<div> <b>Edad:</b> "+_v.age;if(_v.age_group!=""){b+=" / "+_v.age_group}b+="</div> "}if(_v.condition!=""){b+="<div><b>Condición:</b> "+_v.condition;if(_v.sub_condition!=""){b+=" / "+_v.sub_condition}b+="</div> "}if(_v.ethnic_group!=""){b+="<div> <b>Grupo poblacional:</b> "+_v.ethnic_group;if(_v.sub_ethnic_group!=""){b+=" / "+_v.sub_ethnic_group}b+="</div> "}b+="</td>";b+="</table></div> "}}}else{if(_js.v.length>0){b+='<div class="victim"><div><b>Afectación</b></div> ';b+="<div><table><tr>";var s=0;for(var n in _js.v[0]){_v=_js.v[0];if(_v!=""){tdo=(s==0||s==4||s==8||s==12)?true:false;tdc=(s==3||s==7||s==11)?true:false;if(_v[n]!=""){if(tdo){b+="<td>"}b+="<div><b>"+n+"</b>: "+_v[n]+"</div>";if(tdc){b+="</td>"}s+=1}}}b+="</tr></table></div></div>"}}b+='<div class="clear"></div> ';if(show.desc||_js.f.length==0){b+='<div class="desc"><b>Descripci&oacute;n</b>: '+_js.desc+"</div> "}if(show.fuente){if(_js.f!=""){b+='<div class="f"><div class=""><b>Fuente de noticia</b></div>';for(var n=0,h=_js.f.length;n<h;n+=1){b+='<div class="fc">';if((_js.f[n][0]!=""&&_js.f[n][1]!="")||_js.f[n][2]!=""){if((_js.f[n][0]!=""&&_js.f[n][1]!="")){b+='<div class="detail">&raquo; '+_js.f[n][1]+" ( "+_js.f[n][0]+" )"}if(_js.f[n][2].indexOf("http")!=-1){b+='&nbsp;<img src="media/img/pdf.gif" />&nbsp;<a href="ss/?x=232fdsfwwppo&q='+_js.q[0]+_js.id+'" target="_blank">Ver noticia original</a>'}if(_js.f[n][3]!=undefined&&_js.f[n][3]!=""){b+=' | <a href="#" class="d" onclick="return false;">Leer descripci\u00f3n de la fuente</a>'}b+="</div>";if(_js.f[n][3]!=undefined&&_js.f[n][3]!=""){b+='<div class="hide detail">'+_js.f[n][3]+'"';b+='<br /><br />Tomado de: <a href="'+_js.f[n][2]+'" target="_blank">'+_js.f[n][2]+"</a></div>"}}}b+="</div>"}}b+="</div></div>"}if(r.length>g){b+='<div id="mase"><div class="btn"><a href="'+e.link+'" target="_blank">Ir al listado completo de eventos</a></div></div>'}if(is_portal){$("#incidentes").html(b).show();$("#tabs").tabs("select",2);$("#volver").show()}else{numr=(e.id>g)?g:e.id;m({t:"Monitor - ColombiaSSH :: Listado de eventos",html:b,w:800,h:500,funOpen:listReportsEvents})}}})}function showHideFeaturedIcon(){var a=$("#featured");if(layer_ft_exists){a.show()}else{a.hide()}}function mapMove(a){if(mapLoad>0||(l_variacion&&!l_variacion.getVisible())){addFeatures();var b=true;var e=false;if(map.getView().getZoom()>=2){b=false;e=true}}}function styleFunction(g,b){var f=g.getProperties().count;if(_cluster){if(String(g.getProperties().link).indexOf(subdomain_ec)==-1){colorFill="rgba(44,160,44,1)";colorStroke="rgba(44,170,54,0.5)"}else{colorFill="rgba(204,0,0,1)";colorStroke="rgba(204,10,10,0.5)"}}else{colorFill="#FFFFFF";colorStroke="#"+g.getProperties().color}var k=markerRadius;for(var e=1;e<jenks.length;e++){if(f<=jenks[e]){k=(e==1)?7:markerRadius*e;break}}var a=new ol.style.Fill({color:"#fff"});var h=new ol.style.Stroke({color:"rgba(0, 0, 0, 0.6)",width:2});style=[new ol.style.Style({image:new ol.style.Circle({radius:k,fill:new ol.style.Fill({color:colorFill}),stroke:new ol.style.Stroke({color:colorStroke,width:3})}),text:new ol.style.Text({text:f.toString(),fill:a,stroke:h})})];return style}function styleFtFunction(b,a){return[new ol.style.Style({image:new ol.style.Icon(({src:b.get("icon"),size:[24,24]}))})]}function showHideLayers(c){var $vd=$("#variacion_data");var $vdl=$("#variacion_legend");var $tabs=$("#tabs");var $slide_cluster=$("#slide_cluster");if(c=="variacion"){l_ec.setVisible(false);l_dn.setVisible(false);l_ft.setVisible(false);l_variacion.setVisible(true);$vd.show();$vdl.show();$tabs.hide();$slide_cluster.hide()}else{if(l_variacion!==undefined){l_variacion.setVisible(false)}$vd.hide();$vdl.hide();$tabs.show();$slide_cluster.show();var _l=eval("l_"+c);if(_l.getVisible()){l_ft.setVisible(true)}}};