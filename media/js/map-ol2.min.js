var map;var pL;var fromProjection;var toProjection;var features_ec;var features_dn;var markerRadius=7;var Style;var mtipo;var clear=true;var request=false;var filtro=id_filtro="";var nump_list=15;var id_depto="00";var rm_id_depto=false;var id_tema=id_org=0;var maximo=0;var jenks=[];var jenks_cl=5;if(window.location.hostname=="monitor.local"){var subdomain_dn="desastres";var subdomain_ec="violencia";var domain=".local"}else{var subdomain_dn="desastres";var subdomain_ec="violenciaarmada";var domain=".salahumanitaria.co"}var url_ec="&server="+subdomain_ec+domain;var url_dn="&server="+subdomain_dn+domain;var _u="/json/index/?m=0";var url_ft_ec=_u+url_ec;var url_ft_dn=_u+url_dn;var url_xd="/json/cluster/?m=0&v=0";url_ec=url_xd+url_ec;url_dn=url_xd+url_dn;var markerOpacity=0.8;var selectCtrl;var l_ec,l_dn;var mapLoad=0;var _zoomOffset=6;var lym;var lytmp;var resolutions=[2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254];var show=[];show.desc=false;show.fuente=true;function addWMSLayer(h,a,b){var e="http://geonode.salahumanitaria.co/geoserver/wms";if(map.getLayersByName(h).length>0){var g=map.getLayersByName(h)[0];g.setVisibility(b)}else{g=new OpenLayers.Layer.WMS(h,e,{layers:a,transparent:true},{opacity:1,visibility:true,singleTile:true});var f=$("#layers_loading");g.events.register("loadstart",g,function(){f.show()});g.events.register("loadend",g,function(){f.hide()});map.addLayer(g)}}function selDepto(b){var a=b.split(",");map.setCenter(new OpenLayers.LonLat(a[0],a[1]),1)}function resetMap(){map.setCenter(map.maxExtent.getCenterLonLat(),0)}function mapRender(){if(is_portal){_zoomOffset=5;var a=[4891.9698095703125];resolutions=a.concat(resolutions)}fromProjection=new OpenLayers.Projection("EPSG:4326");toProjection=new OpenLayers.Projection("EPSG:900913");OpenLayers.ImgPath=base_ol+"/media/js/openlayers/img/";var b=new OpenLayers.Bounds(-8599122,-471155,-7441396,1505171);map=new OpenLayers.Map({div:"map",displayProjection:toProjection,theme:base_ol+"/media/js/openlayers/theme/default/style.min.css",maxExtent:b,eventListeners:{zoomend:mapMove}});var e=new OpenLayers.Layer.XYZ("Base Layer",["https://api.mapbox.com/styles/v1/mapbox/streets-v8/tiles/${z}/${x}/${y}?access_token=pk.eyJ1IjoicmF0YmlrZXIiLCJhIjoiY2loejFyM3B4MDQwcHRnbTF5MWlmOHJuNCJ9.H5A3WGVx60EdqY0hMzIMKg"],{attribution:"Ver mas detalles en &nbsp;<img src='https://monitor.salahumanitaria.co/favicon.ico'> <a href='https://monitor.salahumanitaria.co' target='_blank'>monitor.salahumanitaria.co</a>",transitionEffect:"resize",zoomOffset:_zoomOffset,sphericalMercator:true,resolutions:resolutions});map.addLayer(e);map.setCenter(map.maxExtent.getCenterLonLat(),0);defStyle();addFeaturesFirstTime()}function addFeaturesFirstTime(){addFeatures();mapLoad=1}function addFeatures(o){if(o==undefined){o="ecdn"}if(!_cluster){url_ec=url_ec.replace("cluster","index");url_dn=url_dn.replace("cluster","index")}else{url_ec=url_ec.replace("index","cluster");url_dn=url_dn.replace("index","cluster")}var e=$("#startDate").val();var i=$("#endDate").val();var r=map.getZoom()+_zoomOffset;var a=map.getCenter();var q=[["s",e],["e",i],["z",r]];if(o=="ecdn"||o=="dn"){var k=q.concat([["c",$("#currentCatD").val()]]);if(map.getLayersByName("Desastres Naturales").length>0){l_dn=map.getLayersByName("Desastres Naturales")[0];l_dn.removeFeatures(l_dn.features)}else{l_dn=new OpenLayers.Layer.Vector("Desastres Naturales",{styleMap:Styles});map.addLayer(l_dn)}var b=addURLParameter(url_dn,k);b=addURLParameter(b,[["states",getStatesChecked()]]);b=addURLParameter(b,[["afectacion",getMapaAfectacion()]]);ajaxFeatures(b,l_dn)}if(o=="ecdn"||o=="ec"){var p=q.concat([["c",$("#currentCatE").val()]]);if(map.getLayersByName("Emergencia Compleja").length>0){l_ec=map.getLayersByName("Emergencia Compleja")[0];l_ec.removeFeatures(l_ec.features)}else{l_ec=new OpenLayers.Layer.Vector("Emergencia Compleja",{styleMap:Styles});map.addLayer(l_ec)}var g=addURLParameter(url_ec,p);g=addURLParameter(g,[["states",getStatesChecked()]]);g=addURLParameter(g,[["afectacion",getMapaAfectacion()]]);ajaxFeatures(g,l_ec)}if(o=="ecdn"||o=="ft"){var n=q.concat([["v",1]]);if(map.getLayersByName("Destacados").length>0){l_ft=map.getLayersByName("Destacados")[0];l_ft.removeFeatures(l_ft.features)}else{l_ft=new OpenLayers.Layer.Vector("Destacados",{styleMap:Styles});map.addLayer(l_ft)}var h=addURLParameter(url_ft_dn,n);h=addURLParameter(h,[["states",getStatesChecked()]]);ajaxFeatures(h,l_ft);var l=addURLParameter(url_ft_ec,n);l=addURLParameter(l,[["states",getStatesChecked()]]);ajaxFeatures(l,l_ft)}if(o=="acceso"){var f=q.concat([["acceso",1]]);f=f.concat([["acceso_cats",getAccesoCats()]]);if(map.getLayersByName("Emergencia Compleja").length>0){l_ec=map.getLayersByName("Emergencia Compleja")[0];l_ec.removeFeatures(l_ec.features)}else{l_ec=new OpenLayers.Layer.Vector("Emergencia Compleja",{styleMap:Styles});map.addLayer(l_ec)}if(map.getLayersByName("Desastres Naturales").length>0){l_dn=map.getLayersByName("Desastres Naturales")[0];l_dn.setVisibility(false)}if(map.getLayersByName("Destacados").length>0){l_ft=map.getLayersByName("Destacados")[0];l_ft.setVisibility(false)}l=addURLParameter(url_ft_ec,f);ajaxFeatures(l,l_ec)}selectCtrl=new OpenLayers.Control.SelectFeature([l_ec,l_dn,l_ft],{clickout:true,onSelect:function(s){onFeatureSelect(s.attributes)}});map.addControl(selectCtrl);selectCtrl.activate()}function onFeatureSelect(e){var b="";var g=20;if(e.link.indexOf("index")>0){var f=e.link.replace("reports","monitor").replace("index","reports_list_map");var a;if(f.indexOf(subdomain_ec)>0){a=$("#currentCatE").val()}else{a=$("#currentCatD").val()}f+="&c="+a}else{var f=e.link.replace("reports","monitor").replace("view","single_report_map")}$.ajax({url:f,dataType:"jsonp",beforeSend:function(){$("#loading").show()},success:function(r){$("#loading").hide();for(var q=0,o=r.length;q<o;q+=1){_js=r[q];b+='<div class="report_list_map from_map"> <div class="t"><a href="#" onclick="return false;" title="'+_js.id+'">'+_js.t+'</a></div> <div><div class="date detail">'+_js.d+'</div> <div class="loc detail">'+_js.ln+' <span class="pdf opt"> <a href="http://sidih.colombiassh.org/sissh/download_pdf.php?c=2&id_depto='+_js.ld+'&id_mun=" target="_blank">Consulte el perfil de '+_js.ldn+"</a></span></div> </div>";b+='<div class="clear"></div><div class="left"><b>Categorias</b></div> <div class="opt right linko"><a href="http://www.colombiassh.org/gtmi/wiki/index.php/Sistema_de_categor%C3%ADas_del_m%C3%B3dulo_de_eventos_de_conflicto" target="_blank">Definici&oacute;n de categorias</a></div>';for(c in _js.c){b+='<div class="clear detail"> &raquo;'+c;if(_js.c[c].length>0){b+=": "}for(d in _js.c[c]){if(d>0){b+=", "}b+=_js.c[c][d]}b+="</div>"}b+='<div class="clear"></div> ';if(_js.q=="violencia"){if(_js.v.length>0){b+="<div><b>Víctimas</b></div> ";for(v in _js.v){_v=_js.v[v];b+='<div class="victim"><div class="right">'+_v.category+"</div><table><tr>";b+='<td valign="top">';b+="<div><b>Cantidad</b>: "+_v.cant+"</div> ";if(_v.gender!=""){b+="<div> <b>Género:</b> "+_v.gender+"</div> "}if(_v.status!=""){b+="<div> <b>Estado:</b> "+_v.status+"</div> "}b+="</td>";b+='<td valign="top">';if(_v.age!=""){b+="<div> <b>Edad:</b> "+_v.age;if(_v.age_group!=""){b+=" / "+_v.age_group}b+="</div> "}if(_v.condition!=""){b+="<div><b>Condición:</b> "+_v.condition;if(_v.sub_condition!=""){b+=" / "+_v.sub_condition}b+="</div> "}if(_v.ethnic_group!=""){b+="<div> <b>Grupo poblacional:</b> "+_v.ethnic_group;if(_v.sub_ethnic_group!=""){b+=" / "+_v.sub_ethnic_group}b+="</div> "}b+="</td>";b+="</table></div> "}}}else{if(_js.v.length>0){b+='<div class="victim"><div><b>Afectación</b></div> ';b+="<div><table><tr>";var s=0;for(var n in _js.v[0]){_v=_js.v[0];if(_v!=""){tdo=(s==0||s==4||s==8||s==12)?true:false;tdc=(s==3||s==7||s==11)?true:false;if(_v[n]!=""){if(tdo){b+="<td>"}b+="<div><b>"+n+"</b>: "+_v[n]+"</div>";if(tdc){b+="</td>"}s+=1}}}b+="</tr></table></div></div>"}}b+='<div class="clear"></div> ';if(show.desc||_js.f.length==0){b+='<div class="desc"><b>Descripci&oacute;n</b>: '+_js.desc+"</div> "}if(show.fuente){if(_js.f!=""){b+='<div class="f"><div class=""><b>Fuente de noticia</b></div>';for(var n=0,h=_js.f.length;n<h;n+=1){b+='<div class="fc">';if((_js.f[n][0]!=""&&_js.f[n][1]!="")||_js.f[n][2]!=""){if((_js.f[n][0]!=""&&_js.f[n][1]!="")){b+='<div class="detail">&raquo; '+_js.f[n][1]+" ( "+_js.f[n][0]+" )"}if(_js.f[n][2].indexOf("http")!=-1){b+='&nbsp;<img src="media/img/pdf.gif" />&nbsp;<a href="ss/?x=232fdsfwwppo&q='+_js.q[0]+_js.id+'" target="_blank">Ver noticia original</a>'}if(_js.f[n][3]!=undefined&&_js.f[n][3]!=""){b+=' | <a href="#" class="d" onclick="return false;">Leer descripci\u00f3n de la fuente</a>'}b+="</div>";if(_js.f[n][3]!=undefined&&_js.f[n][3]!=""){b+='<div class="hide detail">'+_js.f[n][3]+'"';b+='<br /><br />Tomado de: <a href="'+_js.f[n][2]+'" target="_blank">'+_js.f[n][2]+"</a></div>"}}}b+="</div>"}}b+="</div></div>"}if(r.length>g){b+='<div id="mase"><div class="btn"><a href="'+e.link+'" target="_blank">Ir al listado completo de eventos</a></div></div>'}if(is_portal){$("#incidentes").html(b).show();$("#tabs").tabs("select",2);$("#volver").show()}else{numr=(e.id>g)?g:e.id;m({t:"Monitor - ColombiaSSH :: Listado de eventos",html:b,w:800,h:500,funOpen:listReportsEvents})}}})}function ajaxFeatures(e,a){var b=new OpenLayers.Format.GeoJSON({internalProjection:toProjection,externalProjection:fromProjection});$.ajax({url:e,dataType:"jsonp",success:function(h){if(h.features.length>0){var k=b.read(h);var i=h.features;var g=[];for(j in i){c=i[j].properties.count;if(c>maximo){maximo=c}g[j]=c}var f=g.length;if(f>1){if(f<=jenks_cl){jenks_cl=f+1}serie=new geostats(g);cl=(f<jenks_cl)?f-1:jenks_cl;jenks=serie.getClassJenks(cl)}a.addFeatures(k);$("#loading").hide();showHideFeaturedIcon()}},beforeSend:function(){$("#loading").show()}})}function showHideFeaturedIcon(){var a=$("#featured");if(map.getLayersByName("Destacados")[0].features.length>0){a.show()}else{a.hide()}}function mapMove(a){if(mapLoad>0){addFeatures();var b=true;var e=false;if(map.getZoom()>=2){b=false;e=true}}}function defStyle(){var a=new OpenLayers.Style({externalGraphic:"${icon}",graphicTitle:"${cluster_count}",graphicWidth:24,graphicHeight:24,cursor:"pointer",pointRadius:"${radius}",fillColor:"${color}",fillOpacity:"${opacity}",strokeColor:"${strokeColor}",strokeWidth:4,strokeOpacity:"${strokeOpacity}",label:"${clusterCount}",title:"${clusterCount}",fontWeight:"${fontweight}",fontColor:"${fontColor}",fontSize:"${fontsize}"},{context:{fontsize:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return"9px"}else{return"11px"}},fontweight:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return"normal"}else{return"normal"}},radius:function(e){feature_count=e.attributes.count;var f=markerRadius;for(var b=1;b<jenks.length;b++){if(feature_count<=jenks[b]){f=markerRadius*b;return f}}return f},strokeWidth:function(b){if(typeof(b.attributes.strokewidth)!="undefined"&&b.attributes.strokewidth!=""){return b.attributes.strokewidth}else{feature_count=b.attributes.count;if(feature_count>10000){return 18}else{if(feature_count>5000){return 16}else{if(feature_count>1000){return 14}else{if(feature_count>100){return 12}else{if(feature_count>10){return 10}else{if(feature_count>=2){return 5}else{return 1}}}}}}}},color:function(b){if(_cluster){if(String(b.attributes.link).indexOf(subdomain_ec)==-1){return"#2ca02c"}else{return"#cc0000"}}else{return"#ffffff";return"#"+b.attributes.color}},strokeColor:function(b){if(_cluster){if(String(b.attributes.link).indexOf(subdomain_ec)==-1){return"#2ca02c"}else{return"#cc0000"}}else{return"#"+b.attributes.color}},fontColor:function(b){return(_cluster)?"#ffffff":"#000000"},strokeOpacity:function(b){return(_cluster)?"0.5":"1"},clusterCount:function(b){if(b.attributes.count>1){if($.browser.msie&&$.browser.version=="6.0"){return""}return b.attributes.count}else{return"1"}},opacity:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return 1}else{return markerOpacity}},labelalign:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return"c"}else{return"c"}}}});Styles=new OpenLayers.StyleMap({"default":a,select:{fillColor:"#86ABD9",strokeColor:"#32a8a9"}})}function onFeatureUnselect(a){if(a.feature.popup!=null){map.removePopup(a.feature.popup);a.feature.popup.destroy();a.feature.popup=null}}function onPopupClose(a){selectCtrl.unselect(selectedFeature);selectedFeature=null};